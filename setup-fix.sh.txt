#!/bin/bash

set -e

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}======================================${NC}"
echo -e "${BLUE}Card√°pioCasa - Fix Autom√°tico${NC}"
echo -e "${BLUE}======================================${NC}"
echo ""

if [ ! -d ".git" ]; then
    echo -e "${RED}‚ùå Erro: N√£o est√° em um reposit√≥rio git${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì${NC} Reposit√≥rio git detectado"
echo ""

echo -e "${BLUE}[1/6]${NC} Atualizando reposit√≥rio..."
git fetch origin
echo -e "${GREEN}‚úì${NC} Atualizado"
echo ""

echo -e "${BLUE}[2/6]${NC} Criando branch de corre√ß√£o..."
git checkout -b fix/normalize-inventory-and-parseline origin/main 2>/dev/null || git checkout fix/normalize-inventory-and-parseline
echo -e "${GREEN}‚úì${NC} Branch pronta"
echo ""

echo -e "${BLUE}[3/6]${NC} Fazendo backup do arquivo atual..."
if [ -f "cardapio_casa_pwa.html" ]; then
    cp cardapio_casa_pwa.html "cardapio_casa_pwa.html.backup.$(date +%s)"
    echo -e "${GREEN}‚úì${NC} Backup criado"
else
    echo -e "${YELLOW}‚ö†${NC} Arquivo original n√£o encontrado (criar novo)"
fi
echo ""

echo -e "${BLUE}[4/6]${NC} Baixando arquivo corrigido..."
curl -s -o cardapio_casa_pwa.html "https://raw.githubusercontent.com/canabiss2010/Card-pio-da-casa/main/cardapio_casa_pwa.html"

if [ ! -f "cardapio_casa_pwa.html" ] || [ ! -s "cardapio_casa_pwa.html" ]; then
    echo -e "${RED}‚ùå Erro ao baixar arquivo${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì${NC} Arquivo baixado com sucesso"
echo ""

echo -e "${BLUE}[5/6]${NC} Commitando mudan√ßas..."
git add cardapio_casa_pwa.html
git commit -m "fix: normalize names/units, merge inventory items, parse decimals, save plan meta"
echo -e "${GREEN}‚úì${NC} Commit realizado"
echo ""

echo -e "${BLUE}[6/6]${NC} Enviando para GitHub..."
git push -u origin fix/normalize-inventory-and-parseline
echo -e "${GREEN}‚úì${NC} Enviado com sucesso"
echo ""

echo -e "${GREEN}======================================${NC}"
echo -e "${GREEN}‚úì TUDO PRONTO!${NC}"
echo -e "${GREEN}======================================${NC}"
echo ""
echo "üìù Pr√≥ximo passo: Abrir Pull Request"
echo ""
echo "Op√ß√£o A (autom√°tico - se tiver gh instalado):"
echo -e "${BLUE}gh pr create --title 'fix: normalize inventory & parseLine' --body 'Normalize names/units, merge duplicate items, accept decimal comma, save plan metadata.' --base main --head fix/normalize-inventory-and-parseline${NC}"
echo ""
echo "Op√ß√£o B (manual):"
echo "1. Abra: https://github.com/canabiss2010/Card-pio-da-casa"
echo "2. Procure por 'Compare & pull request' (bot√£o amarelo)"
echo "3. Clique em 'Create pull request'"
echo ""
echo "Backup: cardapio_casa_pwa.html.backup.*"
echo ""