<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Card√°pioCasa ‚Äî PWA</title>
  
  <!-- Meta tags para PWA -->
  <meta name="theme-color" content="#1F6F3B"/>
  <meta name="description" content="Aplicativo de planejamento de card√°pio para gerenciar receitas, estoque e criar planos de refei√ß√µes.">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Card√°pioCasa">
  
  <!-- √çcones para PWA -->
  <link rel="manifest" href="cardapio_manifest.json">
  <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçΩÔ∏è</text></svg>">
  <meta name="theme-color" content="#1F6F3B">
  
  <!-- Estilos -->
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- Preload de recursos cr√≠ticos -->
  <link rel="preload" href="js/app.js" as="script" crossorigin="anonymous">
  <link rel="preload" href="css/styles.css" as="style">
  
  <style>
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1F6F3B;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
  </style>
</head>
<body>
  <!-- Aviso de carregamento -->
  <div id="loading" class="loading-overlay" aria-live="polite" aria-busy="true">
    <div class="loading-spinner"></div>
    <p>Carregando...</p>
  </div>

  <div class="wrap" aria-hidden="true">
    <header role="banner">
      <div class="logo" aria-hidden="true" style="width: 48px; height: 48px; background-color: #1F6F3B; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">üçΩÔ∏è</div>
      <div>
        <h1>Card√°pioCasa</h1>
        <p class="subtitle">Planejamento r√°pido para sua casa</p>
      </div>
    </header>

    <main id="main-content" role="main">
      <div class="grid" id="mainGrid">
        <div class="block" id="b-inv" tabindex="0" role="button" aria-labelledby="inv-title inv-desc">
          <h3 id="inv-title">Dispensa</h3>
          <p id="inv-desc">Adicionar e visualizar seu estoque</p>
        </div>
        
        <div class="block" id="b-rec" tabindex="0" role="button" aria-labelledby="rec-title rec-desc">
          <h3 id="rec-title">Receitas</h3>
          <p id="rec-desc">Cadastrar e priorizar receitas</p>
        </div>
        
        <div class="block" id="b-create" tabindex="0" role="button" aria-labelledby="create-title create-desc">
          <h3 id="create-title">Criar Plano</h3>
          <p id="create-desc">Gerar plano autom√°tico</p>
        </div>
        
        <div class="block" id="b-current" tabindex="0" role="button" aria-labelledby="current-title current-desc">
          <h3 id="current-title">Plano Atual</h3>
          <p id="current-desc">Ver plano gerado</p>
        </div>
      </div>

      <div class="alerts full" id="alertsBox" role="alert" aria-live="polite">
        <strong style="color:var(--accent)">Avisos</strong>
        <div id="alerts" style="margin-top:8px" class="small">Nenhum aviso por enquanto.</div>
      </div>
    </main>

    <footer role="contentinfo">
      <p>Toque nos blocos para abrir cada √°rea. App pronto como PWA (instal√°vel).</p>
      <p class="small">Vers√£o 1.0.0</p>
    </footer>
  </div>

  <!-- Modal -->
  <div class="modal-back" id="modalBack" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
    <div class="modal" id="modalContent" role="document">
      <h2 id="modalTitle" class="visually-hidden">Janela de di√°logo</h2>
      <p id="modalDesc" class="visually-hidden">Conte√∫do da janela de di√°logo</p>
      <!-- O conte√∫do ser√° inserido aqui dinamicamente -->
    </div>
  </div>

<script>
// Core app logic (v6 visual PWA): four blocks that open details; densities preloaded silently.
// Data stored in localStorage keys cc_inv_pwa, cc_rec_pwa
const qs = s => document.querySelector(s);

const densities = {
  "√°gua":1,"agua":1,"leite":1,"oleo":0.92,"√≥leo":0.92,"acucar":0.85,"a√ß√∫car":0.85,"farinha":0.53,"farinha de trigo":0.53,
  "arroz":0.85,"feijao":0.7,"carne moida":0.95,"carne mo√≠da":0.95,"batata":0.65,"tomate":0.95,"aipim":0.6,"mandioquinha":0.6,
  "√≥leo vegetal":0.92,"manteiga":0.96,"creme de leite":1.01,"iogurte":1.03,"queijo ralado":0.32,"a√ß√∫car cristal":0.85,
  "acucar cristal":0.85,"cafe moido":0.5,"sal":1.2,"cebola":0.64,"alho":0.6,"atum":0.8,"milho":0.72,"ervilha":0.72
};

// basic defaults
const defaults = {
  conv: { kg_to_g:1000, g_to_mg:1000, l_to_ml:1000, cup_ml:240, tbsp_ml:15, tsp_ml:5 }
};

// storage
let inventory = JSON.parse(localStorage.getItem('cc_inv_pwa')||'[]');
let recipes = JSON.parse(localStorage.getItem('cc_rec_pwa')||'[]');
let plan = JSON.parse(localStorage.getItem('cc_plan_pwa')||'[]');

// UI hooks
const modalBack = qs('#modalBack');
const modalContent = qs('#modalContent');
const alertsEl = qs('#alerts');

function saveAll(){
  localStorage.setItem('cc_inv_pwa', JSON.stringify(inventory));
  localStorage.setItem('cc_rec_pwa', JSON.stringify(recipes));
  localStorage.setItem('cc_plan_pwa', JSON.stringify(plan));
}

// helpers
function normalizeUnit(u){
  if(!u) return 'un';
  const key = u.toString().toLowerCase().replace(/\s+/g,'').replace(/[.,]/g,'').trim();
  const map = {'kg':'kg','kilo':'kg','g':'g','grama':'g','l':'l','litro':'l','ml':'ml','xic':'xic','xicara':'xic','x√≠cara':'xic','cs':'cs','colher_sopa':'cs','ch':'ch','colher_cha':'ch','un':'un','lat':'lat'};
  return map[key]||key;
}
function parseLine(line){
  const parts = line.split(',').map(s=>s.trim()).filter(Boolean);
  if(parts.length===0) return null;
  if(parts.length===1) return {name:parts[0].toLowerCase(), qty:1, unit:'un'};
  return {name:parts[0].toLowerCase(), qty:parseFloat(parts[1])||0, unit:normalizeUnit(parts[2]||'un')};
}
function toGrams(qty, unit, name){
  if(qty==null || isNaN(qty)) return null;
  const u = normalizeUnit(unit||'un');
  const c = defaults.conv;
  if(u==='g') return qty;
  if(u==='kg') return qty * c.kg_to_g;
  if(u==='mg') return qty / c.g_to_mg;
  if(u==='ml'){ const d = densityFor(name); return d!=null? qty * d : null; }
  if(u==='l'){ const ml = qty * c.l_to_ml; const d = densityFor(name); return d!=null? ml * d : null; }
  if(u==='xic'){ const ml = qty * c.cup_ml; const d = densityFor(name); return d!=null? ml * d : null; }
  if(u==='cs'){ const ml = qty * c.tbsp_ml; const d = densityFor(name); return d!=null? ml * d : null; }
  if(u==='ch'){ const ml = qty * c.tsp_ml; const d = densityFor(name); return d!=null? ml * d : null; }
  return null;
}
function densityFor(name){
  if(!name) return null;
  const k = name.toLowerCase().trim();
  if(densities[k]!=null) return densities[k];
  const alt = k.replace(/\s+s$/,'');
  if(densities[alt]!=null) return densities[alt];
  return null;
}

// Alerts management
function setAlert(text, level='info'){
  const msg = {text, level, time: new Date().toISOString()};
  // simple push to alerts area (show latest)
  const node = document.createElement('div'); node.textContent = `${text}`; node.style.marginTop='6px';
  if(level==='error') node.style.color='crimson';
  else if(level==='warn') node.style.color='#b47c00';
  else node.style.color='#134e3a';
  alertsEl.prepend(node);
}

// Modal helpers
function openModal(title, contentHTML){
  modalContent.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h2 style="margin:0">${title}</h2><button id="closeModal" class="btn-ghost">Fechar</button></div><div style="margin-top:12px">${contentHTML}</div>`;
  modalBack.style.display = 'flex';
  qs('#closeModal').addEventListener('click', ()=> closeModal());
}
function closeModal(){ modalBack.style.display='none'; modalContent.innerHTML=''; }

// Build modal UIs for each block
function showInventory(){
  const html = `
    <div style="display:flex;gap:8px"><input id="m_invLine" placeholder="ex: arroz,2,kg" /><button id="m_addInv" class="btn-ghost">Adicionar</button></div>
    <label style="margin-top:8px">Cole v√°rias linhas</label>
    <textarea id="m_invBulk" rows="6" placeholder="arroz,2,kg\nleite,2,l"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="m_paste" class="btn">Adicionar todas</button><button id="m_clearInv" class="btn-ghost">Limpar</button></div>
    <div id="m_invList" class="list" style="margin-top:12px"></div>
  `;
  openModal('Dispensa', html);
  // attach handlers after short delay
  setTimeout(()=> {
    const render = ()=> {
      const el = qs('#m_invList'); el.innerHTML='';
      if(inventory.length===0) el.innerHTML='<div class="small">Sem itens</div>';
      inventory.forEach((it,idx)=>{
        const node = document.createElement('div'); node.className='item';
        node.innerHTML = `<div style="max-width:70%"><strong style="text-transform:capitalize">${it.name}</strong><div class="small">${it.qty} ${it.unit}</div></div><div><button data-idx="${idx}" class="btn-ghost">Remover</button></div>`;
        el.appendChild(node);
      });
      el.querySelectorAll('button[data-idx]').forEach(b=> b.addEventListener('click', ()=> { const i=Number(b.dataset.idx); inventory.splice(i,1); saveAll(); render(); setAlert('Item removido: '+b.previousSibling); }));
    };
    qs('#m_addInv').addEventListener('click', ()=> {
      const v = qs('#m_invLine').value.trim(); if(!v) return alert('Digite: nome,quantidade,unidade');
      const p = parseLine(v); if(!p) return alert('linha inv√°lida');
      inventory.push(p); saveAll(); render(); qs('#m_invLine').value=''; setAlert('Item adicionado: '+p.name);
    });
    qs('#m_paste').addEventListener('click', ()=> {
      const text = qs('#m_invBulk').value.trim(); if(!text) return alert('Cole as linhas');
      const lines = text.split('\n').map(l=>l.trim()).filter(Boolean); let added=0;
      lines.forEach(l=>{ const p=parseLine(l); if(p){ inventory.push(p); added++; } });
      saveAll(); render(); qs('#m_invBulk').value=''; setAlert('Adicionados em lote: '+added);
    });
    qs('#m_clearInv').addEventListener('click', ()=> { if(!confirm('Limpar invent√°rio?')) return; inventory=[]; saveAll(); render(); setAlert('Invent√°rio limpo'); });
    render();
  },50);
}

function showRecipes(){
  const html = `
    <label>Nome</label><input id="m_recName" placeholder="Carne mo√≠da e batata" />
    <label>Rende (person-meals)</label><input id="m_recServes" type="number" value="8" />
    <label>Ingredientes (uma por linha: nome,quantidade,unidade)</label><textarea id="m_recIngredients" rows="6" placeholder="carne moida,800,g\nbatata,1.5,kg"></textarea>
    <label>Prioridade (1-10)</label><input id="m_recPriority" type="number" value="7" min="1" max="10" />
    <label>Dias que dura o preparo</label><input id="m_recDays" type="number" value="2" min="1" max="5" />
    <div style="display:flex;gap:8px;margin-top:8px"><button id="m_addRec" class="btn">Adicionar</button><button id="m_clearRec" class="btn-ghost">Limpar receitas</button></div>
    <div id="m_recList" class="list" style="margin-top:12px"></div>
  `;
  openModal('Receitas', html);
  setTimeout(()=> {
    const render = ()=> {
      const el = qs('#m_recList'); el.innerHTML='';
      if(recipes.length===0) el.innerHTML='<div class="small">Sem receitas</div>';
      recipes.forEach((r,idx)=>{
        const node = document.createElement('div'); node.className='item';
        node.innerHTML = `<div style="max-width:70%"><strong style="text-transform:capitalize">${r.name}</strong><div class="small">Rende ${r.serves} ¬∑ Dura ${r.days} dia(s) ¬∑ P${r.priority}</div></div><div><button data-idx="${idx}" class="btn-ghost">Remover</button></div>`;
        el.appendChild(node);
      });
      el.querySelectorAll('button[data-idx]').forEach(b=> b.addEventListener('click', ()=> { recipes.splice(Number(b.dataset.idx),1); saveAll(); render(); setAlert('Receita removida'); }));
    };
    qs('#m_addRec').addEventListener('click', ()=> {
      const name = qs('#m_recName').value.trim(); if(!name) return alert('Nome da receita');
      const serves = parseInt(qs('#m_recServes').value)||1;
      const lines = qs('#m_recIngredients').value.split('\n').map(l=>l.trim()).filter(Boolean);
      if(!lines.length) return alert('Adicione ingredientes');
      const priority = Math.max(1, Math.min(10, parseInt(qs('#m_recPriority').value)||5));
      const days = Math.max(1, Math.min(5, parseInt(qs('#m_recDays').value) || 2));
      const ingredients = lines.map(l=>{ const p=parseLine(l); return {name:p.name, qty:p.qty, unit:p.unit}; });
      recipes.push({name, serves, ingredients, priority, days});
      saveAll(); render(); qs('#m_recName').value=''; qs('#m_recIngredients').value=''; setAlert('Receita adicionada: '+name);
    });
    qs('#m_clearRec').addEventListener('click', ()=> { if(!confirm('Limpar receitas?')) return; recipes=[]; saveAll(); render(); setAlert('Receitas limpas'); });
    render();
  },50);
}

function showCreatePlan(){
  const html = `
    <div class="small">Ajuste as configura√ß√µes e gere um plano autom√°tico. O sistema usa prioridades e dura√ß√µes (sobras).</div>
    <label>Pessoas</label><input id="m_people" type="number" value="4" />
    <label>Dias</label><input id="m_days" type="number" value="7" />
    <label>Refei√ß√µes por dia</label><select id="m_meals"><option value="2">2</option><option value="3">3</option><option value="1">1</option></select>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="m_genPlan" class="btn">Gerar Plano</button><button id="m_sim" class="btn-ghost">Simular (sem consumir estoque)</button></div>
    <div id="m_planPreview" style="margin-top:12px"></div>
  `;
  openModal('Criar Plano', html);
  setTimeout(()=> {
    const renderPreview = (p)=> {
      const el = qs('#m_planPreview'); el.innerHTML='';
      if(!p.length){ el.innerHTML='<div class="small">Sem plano</div>'; return; }
      p.forEach((day,idx)=>{
        const node = document.createElement('div'); node.style.borderTop='1px solid rgba(8,20,25,0.04)'; node.style.padding='8px 0';
        node.innerHTML = `<strong>Dia ${idx+1}</strong>`;
        day.forEach((meal,i)=> {
          const m = document.createElement('div'); m.style.marginTop='6px';
          m.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>Refei√ß√£o ${i+1}: ${meal.name}</strong><div class="small">${meal.suggested? 'Sugest√£o (faltam ingredientes)':'Agendado'}</div></div></div>`;
          node.appendChild(m);
        });
        el.appendChild(node);
      });
    };

    qs('#m_genPlan').addEventListener('click', ()=> {
      const people = parseInt(qs('#m_people').value)||1;
      const days = parseInt(qs('#m_days').value)||7;
      const mealsPerDay = parseInt(qs('#m_meals').value)||2;
      if(recipes.length===0) return alert('Adicione receitas primeiro');
      // simple planner reusing earlier logic
      let workingInv = inventory.map(x=>({...x}));
      const newPlan = [];
      let activePrepared = [];
      for(let d=0; d<days; d++){
        const day = [];
        for(let m=0; m<mealsPerDay; m++){
          let assigned = null;
          if(activePrepared.length){
            for(let i=0;i<activePrepared.length;i++){
              const p = activePrepared[i];
              if(p.remainingSlots>0){ assigned = {name:p.recipe.name, suggested:false, recipe:p.recipe}; p.remainingSlots -=1; break; }
            }
            activePrepared = activePrepared.filter(p=>p.remainingSlots>0);
          }
          if(!assigned){
            // pick candidate by priority that can be cooked to cover its days
            let candidate=null;
            for(const r of recipes){
              const totalPersonMeals = people * r.days;
              const cookingsNeeded = Math.ceil(totalPersonMeals / r.serves);
              if(canCookForSlots(r, workingInv, cookingsNeeded)) { candidate = {r,cookingsNeeded}; break; }
            }
            if(candidate){
              workingInv = consumeCookingsInv(candidate.r, workingInv, candidate.cookingsNeeded);
              const remainingSlots = candidate.r.days -1;
              if(remainingSlots>0) activePrepared.push({recipe:candidate.r, remainingSlots});
              assigned = {name:candidate.r.name, suggested:false, recipe:candidate.r};
            } else {
              // fallback: pick best shortage
              let best=null; let bestShort=Infinity;
              for(const r of recipes){
                const totalPersonMeals = people * r.days;
                const cookingsNeeded = Math.ceil(totalPersonMeals / r.serves);
                let shortage=0;
                r.ingredients.forEach(ing=>{
                  const needTotalQty = ing.qty * cookingsNeeded;
                  const needG = toGrams(needTotalQty, ing.unit, ing.name);
                  if(needG!=null){
                    const found = workingInv.find(x=>x.name.toLowerCase()===ing.name.toLowerCase());
                    const have = found? toGrams(found.qty, found.unit, found.name) : null;
                    if(needG!=null && have!=null) shortage += Math.max(0, needG - have);
                    else if(needG!=null && have==null) shortage += needG;
                    else {
                      const haveQty = found?found.qty:0;
                      shortage += Math.max(0, needTotalQty - haveQty);
                    }
                  });
                });
                if(shortage < bestShort){ bestShort = shortage; best={r,cookingsNeeded}; }
              }
              if(best){ workingInv = consumeCookingsInv(best.r, workingInv, best.cookingsNeeded); assigned = {name:best.r.name, suggested:true, recipe:best.r}; }
              else assigned = {name:'Sem sugest√£o', suggested:true};
            }
          }
          day.push(assigned);
        }
        newPlan.push(day);
      }
      const wrap = document.querySelector('.wrap');
      if (wrap) {
        wrap.setAttribute('aria-hidden', 'false');
      }
      
      // Adiciona classes para estiliza√ß√£o dos blocos
      document.querySelectorAll('.block').forEach(block => {
        block.classList.add('interactive');
      });
    });
    
    // Registra o Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('cardapio_sw.js')
          .then(registration => {
            console.log('ServiceWorker registrado com sucesso:', registration.scope);
          })
          .catch(error => {
            console.error('Falha ao registrar ServiceWorker:', error);
          });
      });
    }
  </script>
  
  <!-- M√≥dulos JavaScript -->
  <script type="module" src="js/app.js"></script>
  
  <!-- Fallback para navegadores sem suporte a m√≥dulos -->
  <script nomodule>
    const fallback = document.createElement('div');
    fallback.style.padding = '2rem';
    fallback.style.textAlign = 'center';
    fallback.style.fontFamily = 'sans-serif';
    fallback.innerHTML = `
      <h1>Navegador n√£o suportado</h1>
      <p>Este aplicativo requer um navegador moderno com suporte a m√≥dulos JavaScript.</p>
      <p>Por favor, atualize seu navegador ou use uma vers√£o mais recente.</p>
    `;
    document.body.innerHTML = '';
    document.body.appendChild(fallback);
  </script>
</body>
</html>
